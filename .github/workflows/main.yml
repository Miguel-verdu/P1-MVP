name: CI con AutoCommit y Docs

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write

jobs:
  test-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Instalar dependencias
        run: |
          pip install pytest
          pip install pdoc

      - name: Ejecutar script de tests y actualizar README
        run: python src/update_readme.py

      - name: Generar documentación HTML con pdoc
        run: |
          mkdir -p docs_html
          # Probar si los archivos existen
          echo "Archivos en src/:"
          ls -la src/
          # Generar documentación para todos los módulos Python en src/
          pdoc --output-dir docs_html src/

      - name: Verificar documentación generada
        run: |
          echo "Contenido de docs_html/:"
          ls -la docs_html/

      - name: Sincronizar rama y subir cambios
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"

          git stash push --include-untracked -m "ci-temp-stash" || true
          git fetch origin main
          git rebase origin/main || (git rebase --abort && exit 1)
          if git stash list | grep -q "ci-temp-stash"; then git stash pop || exit 1; fi

          git add -A
          git diff --cached --quiet || git commit -m "Update README y documentación"
          git push origin HEAD:main

  deploy-docs:
    runs-on: ubuntu-latest
    needs: test-and-update
    permissions:
      contents: write
      pages: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Configure Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install pdoc
        run: pip install pdoc

      - name: Generate HTML documentation
        run: |
          mkdir -p docs_html
          # Asegurar que docs_html esté limpio
          rm -rf docs_html/*
          # Generar documentación para todo el directorio src
          pdoc --output-dir docs_html src/

      - name: Verificar archivos generados
        run: |
          echo "Estructura de docs_html/:"
          find docs_html/ -type f -name "*.html"

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs_html/
          force_orphan: true
