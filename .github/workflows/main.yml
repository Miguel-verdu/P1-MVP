name: CI con AutoCommit y Docs

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  pages: write

jobs:
  test-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configurar Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Instalar dependencias
        run: |
          pip install pytest
          pip install pdoc

      - name: Ejecutar script de tests y actualizar README
        run: python src/update_readme.py

      - name: Generar documentación HTML con pdoc
        run: |
          # Eliminar el __init__.py vacío temporalmente para que pdoc funcione mejor
          if [ -f "src/__init__.py" ] && [ ! -s "src/__init__.py" ]; then
            mv src/__init__.py src/__init__.py.backup
          fi
          
          mkdir -p docs_html
          # Generar documentación para cada módulo individualmente
          pdoc --html --output-dir docs_html src/main.py src/update_readme.py
          
          # Restaurar __init__.py si existía
          if [ -f "src/__init__.py.backup" ]; then
            mv src/__init__.py.backup src/__init__.py
          fi
          
          # Verificar si se generó documentación
          echo "Verificando documentación generada:"
          ls -la docs_html/

      - name: Sincronizar rama y subir cambios
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"

          git stash push --include-untracked -m "ci-temp-stash" || true
          git fetch origin main
          git rebase origin/main || (git rebase --abort && exit 1)
          if git stash list | grep -q "ci-temp-stash"; then git stash pop || exit 1; fi

          # Añadir la documentación generada
          if [ -d "docs_html" ]; then
            git add docs_html/
          fi
          git add -A
          git diff --cached --quiet || git commit -m "Update README y documentación"
          git push origin HEAD:main

  deploy-docs:
    runs-on: ubuntu-latest
    needs: test-and-update
    permissions:
      contents: write
      pages: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Configure Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install pdoc
        run: pip install pdoc

      - name: Generate HTML documentation
        run: |
          mkdir -p docs_html
          # Eliminar __init__.py vacío temporalmente
          if [ -f "src/__init__.py" ] && [ ! -s "src/__init__.py" ]; then
            mv src/__init__.py src/__init__.py.backup
          fi
          
          # Generar documentación con formato HTML explícito
          pdoc --html --output-dir docs_html src/main.py src/update_readme.py
          
          # Restaurar __init__.py
          if [ -f "src/__init__.py.backup" ]; then
            mv src/__init__.py.backup src/__init__.py
          fi
          
          # Crear índice si no existe
          if [ ! -f "docs_html/index.html" ]; then
            # Crear un índice simple que liste los módulos
            cat > docs_html/index.html << 'EOF'
            <!DOCTYPE html>
            <html>
            <head>
                <title>Documentación del Proyecto</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 40px; }
                    h1 { color: #333; }
                    ul { list-style-type: none; padding: 0; }
                    li { margin: 10px 0; }
                    a { text-decoration: none; color: #0366d6; }
                    a:hover { text-decoration: underline; }
                </style>
            </head>
            <body>
                <h1>Documentación del Proyecto</h1>
                <p>Selecciona un módulo para ver su documentación:</p>
                <ul>
            EOF
            
            # Añadir enlaces a los módulos documentados
            for html_file in docs_html/*.html; do
              if [ "$(basename "$html_file")" != "index.html" ]; then
                module_name=$(basename "$html_file" .html)
                echo "                    <li><a href=\"$module_name.html\">$module_name</a></li>" >> docs_html/index.html
              fi
            done
            
            cat >> docs_html/index.html << 'EOF'
                </ul>
            </body>
            </html>
            EOF
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./docs_html
          force_orphan: true
